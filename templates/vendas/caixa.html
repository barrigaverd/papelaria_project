{% extends "base.html" %}

{% block content %}
<div class="row g-3" style="height: 80vh;">
    <div class="col-md-8">
        <div class="card h-100 shadow-sm">
            <div class="card-header bg-white py-3">
                <div class="input-group">
                    <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control bg-light border-start-0" placeholder="Pesquisar produto...">
                </div>
            </div>
            <div class="card-body overflow-auto p-0">
                <div class="list-group list-group-flush">
                    {% for produto in produtos %}
                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3">
                        <div>
                            <h6 class="mb-0 fw-bold">{{ produto.nome }}</h6>
                            <small class="text-muted">
                                Estoque: {{ produto.estoque_atual }} | 
                                Preço: R$ {{ "%.2f"|format(produto.preco_venda) }}
                            </small>
                        </div>
                        <button class="btn btn-outline-primary btn-sm rounded-pill px-3" 
                                data-bs-toggle="modal" 
                                data-bs-target="#modalAjusteItem"
                                data-id="{{ produto.id }}"
                                data-nome="{{ produto.nome }}"
                                data-preco="{{ produto.preco_venda }}">
                            <i class="bi bi-plus-lg me-1"></i>Adicionar
                        </button>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <p class="text-muted">Nenhum produto encontrado para esta papelaria.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card h-100 shadow-sm border-primary">
            <div class="card-header bg-primary text-white text-center py-3">
                <h5 class="mb-0"><i class="bi bi-receipt me-2"></i>Cupom de Venda</h5>
            </div>
            <div class="card-body d-flex flex-column p-0">
                <div class="flex-grow-1 p-3 overflow-auto" id="lista-itens-cupom">
                    <div id="aviso-vazio" class="text-center py-5 text-muted">
                        <i class="bi bi-cart3 fs-1 d-block"></i>
                        Aguardando produtos...
                    </div>
                </div>

                <div class="bg-light p-3 border-top">
                    <div class="d-flex justify-content-between h4 mb-3 text-primary">
                        <span>TOTAL:</span>
                        <span class="fw-bold">R$ <span id="valor-total-cupom">0.00</span></span>
                    </div>
                    <button class="btn btn-primary w-100 btn-lg shadow-sm" id="btn-finalizar" disabled>
                        Finalizar Pagamento
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalAjusteItem" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-dark text-white">
                <h6 class="modal-title" id="nomeProdutoModal">Ajustar Item</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="idProdutoModal">
                
                <div class="mb-3">
                    <label class="form-label small fw-bold">Quantidade</label>
                    <input type="number" id="qtdModal" class="form-control form-control-lg text-center" value="1" min="1">
                </div>
                
                <div class="mb-3">
                    <label class="form-label small fw-bold">Preço Unitário (R$)</label>
                    <input type="number" step="0.01" id="precoModal" class="form-control form-control-lg text-center text-success fw-bold">
                    <div class="form-text text-center">Você pode alterar para dar desconto.</div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-primary w-100 py-2" onclick="confirmarInclusao()">
                    Confirmar no Cupom
                </button>
            </div>
        </div>
    </div>
</div>
<script>
    let totalVenda = 0;

    // Captura os dados ao abrir o Modal (Já fizemos no passo anterior)
    var modalAjuste = document.getElementById('modalAjusteItem');
    modalAjuste.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        document.getElementById('idProdutoModal').value = button.getAttribute('data-id');
        document.getElementById('nomeProdutoModal').innerText = button.getAttribute('data-nome');
        document.getElementById('precoModal').value = button.getAttribute('data-preco');
        document.getElementById('qtdModal').value = 1;
    });

    function confirmarInclusao() {
        // 1. Pega os valores ajustados no Modal
        const nome = document.getElementById('nomeProdutoModal').innerText;
        const qtd = parseInt(document.getElementById('qtdModal').value);
        const preco = parseFloat(document.getElementById('precoModal').value);
        const subtotal = qtd * preco;

        // 2. Remove o aviso de "vazio" se for o primeiro item
        const avisoVazio = document.getElementById('aviso-vazio');
        if (avisoVazio) avisoVazio.remove();

        // 3. Cria a linha do item no cupom
        const lista = document.getElementById('lista-itens-cupom');
        const itemHtml = `
            <div class="d-flex justify-content-between align-items-start border-bottom mb-2 pb-2 item-cupom" 
                data-subtotal="${subtotal}">
                <div class="me-auto">
                    <div class="fw-bold">${nome}</div>
                    <small class="text-muted">${qtd} un x R$ ${preco.toFixed(2)}</small>
                </div>
                <div class="text-end">
                    <div class="fw-bold">R$ ${subtotal.toFixed(2)}</div>
                    <button class="btn btn-link btn-sm text-danger p-0" 
                            onclick="removerItem(this, ${subtotal})">
                        Remover
                    </button>
                </div>
            </div>
        `;
        lista.insertAdjacentHTML('beforeend', itemHtml);

        // 4. Atualiza o Total Geral
        totalVenda += subtotal;
        document.getElementById('valor-total-cupom').innerText = totalVenda.toFixed(2);
        document.getElementById('btn-finalizar').disabled = false;

        // 5. Fecha o Modal
        bootstrap.Modal.getInstance(modalAjuste).hide();
    }
    function atualizarTotal() {
        let novoTotal = 0;
        // Busca todos os elementos que contém o valor do subtotal no cupom
        const subtotais = document.querySelectorAll('#lista-itens-cupom .fw-bold.text-end div, #lista-itens-cupom .text-end .fw-bold');
        
        // Como a estrutura acima pode variar, vamos simplificar a lógica de soma
        // Baseado no valor total que já temos ou recalculando pelas linhas
        // Vamos usar a lógica mais robusta: somar todos os valores finais das linhas
        
        // Se o cupom ficar vazio, mostra o aviso novamente
        const lista = document.getElementById('lista-itens-cupom');
        if (lista.children.length === 0) {
            lista.innerHTML = '<div id="aviso-vazio" class="text-center py-5 text-muted"><i class="bi bi-cart3 fs-1 d-block"></i>Aguardando produtos...</div>';
            totalVenda = 0;
            document.getElementById('btn-finalizar').disabled = true;
        } else {
            // Lógica simplificada: Recalcular o total baseando-se no que sobrou
            // Para este passo, vamos apenas resetar o total global ao remover via 'this'
            // Mas a forma correta é iterar. Vamos manter simples para o teste:
            // (Apenas para este teste, o totalVenda será ajustado manualmente no onclick)
        }
    }
    function removerItem(botao, valorItem) {
        // 1. Remove a linha do HTML
        const linha = botao.closest('.item-cupom');
        linha.remove();

        // 2. Subtrai o valor do total global
        totalVenda -= valorItem;

        // 3. Garante que o total nunca seja negativo (devido a arredondamentos)
        if (totalVenda < 0) totalVenda = 0;

        // 4. Atualiza o valor na tela
        document.getElementById('valor-total-cupom').innerText = totalVenda.toFixed(2);

        // 5. Se o cupom ficou vazio, reseta o visual
        const lista = document.getElementById('lista-itens-cupom');
        if (lista.querySelectorAll('.item-cupom').length === 0) {
            lista.innerHTML = `
                <div id="aviso-vazio" class="text-center py-5 text-muted">
                    <i class="bi bi-cart3 fs-1 d-block"></i>
                    Aguardando produtos...
                </div>`;
            document.getElementById('btn-finalizar').disabled = true;
        }
    }
</script>
{% endblock %}