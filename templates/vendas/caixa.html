{% extends "base.html" %}

{% block content %}
<div class="row g-3" style="height: 85vh;">
    <div class="col-md-8">
        <div class="card h-100 shadow-sm border-0">
            <div class="card-header bg-white py-3 border-0">
                <div class="input-group input-group-lg shadow-sm">
                    <span class="input-group-text bg-light border-end-0"><i class="bi bi-search text-primary"></i></span>
                    <input type="text" id="campo-busca" class="form-control bg-light border-start-0" 
                           placeholder="Digite o nome do produto ou serviço..." autocomplete="off" autofocus>
                </div>
            </div>
            <div class="card-body overflow-auto p-0">
                <div id="lista-busca" class="list-group list-group-flush">
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-arrow-up-circle fs-1 d-block mb-2"></i>
                        Comece a digitar para buscar itens...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card h-100 shadow-sm border-primary border-2">
            <div class="card-header bg-primary text-white text-center py-3">
                <h5 class="mb-0 fw-bold"><i class="bi bi-receipt me-2"></i>CUPOM DE VENDA</h5>
            </div>
            <div class="card-body d-flex flex-column p-0">
                <div class="flex-grow-1 p-3 overflow-auto" id="lista-itens-cupom">
                    <div id="aviso-vazio" class="text-center py-5 text-muted">
                        <i class="bi bi-cart3 fs-1 d-block"></i> Aguardando itens...
                    </div>
                </div>

                <div class="bg-dark p-3 text-white">
                    <div class="d-flex justify-content-between h4 mb-3">
                        <span class="opacity-75">TOTAL:</span>
                        <span class="fw-bold text-warning">R$ <span id="valor-total-cupom">0.00</span></span>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-light w-50" onclick="limparCupom()">
                            <i class="bi bi-trash"></i> Limpar
                        </button>
                        <button class="btn btn-warning w-50 fw-bold shadow-sm" id="btn-finalizar" 
                                data-bs-toggle="modal" data-bs-target="#modalPagamento" disabled>
                            PAGAMENTO
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAjusteItem" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-dark text-white">
                <h6 class="modal-title" id="nomeItemModal">Ajustar Item</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="idItemModal">
                <input type="hidden" id="tipoItemModal">
                <div class="mb-3">
                    <label class="form-label small fw-bold">Quantidade</label>
                    <input type="number" id="qtdModal" class="form-control form-control-lg text-center" value="1" min="1">
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold">Preço Unitário (R$)</label>
                    <input type="number" step="0.01" id="precoModal" class="form-control form-control-lg text-center text-success fw-bold">
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-primary w-100 py-2 fw-bold" onclick="confirmarInclusao()">CONFIRMAR</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalPagamento" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold"><i class="bi bi-cash-stack me-2"></i>Finalizar Checkout</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
                <div class="row">
                    <div class="col-md-7 border-end">
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted">CLIENTE</label>
                            <select id="cliente_id" class="form-select shadow-sm">
                                <option value="">Consumidor Final</option>
                                {% for cliente in clientes %}
                                    <option value="{{ cliente.id }}">{{ cliente.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="card shadow-sm mb-3">
                            <div class="card-body">
                                <label class="form-label fw-bold small text-muted">FORMA DE PAGAMENTO</label>
                                <div class="input-group">
                                    <select id="select_forma" class="form-select">
                                        {% for forma in formas_pagamento %}
                                            <option value="{{ forma.nome }}">{{ forma.nome }}</option>
                                        {% endfor %}
                                    </select>
                                    <input type="number" id="valor_parcial" class="form-control" placeholder="R$ 0,00" step="0.01">
                                    <button class="btn btn-success" onclick="adicionarPagamento()">
                                        <i class="bi bi-plus-lg"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="lista-pagamentos" class="list-group shadow-sm mb-3"></div>
                        <input type="date" id="data_venda" class="form-control shadow-sm" value="{{ now.strftime('%Y-%m-%d') }}">
                    </div>
                    <div class="col-md-5">
                        <div class="card bg-white h-100 border-0 shadow-sm text-center p-3">
                            <div class="mb-3">
                                <span class="text-muted d-block small">VALOR A PAGAR</span>
                                <h3 class="text-dark fw-bold">R$ <span id="dash-total">0.00</span></h3>
                            </div>
                            <div class="mb-3">
                                <span class="text-muted d-block small">VALOR PAGO</span>
                                <h3 class="text-primary fw-bold">R$ <span id="dash-pago">0.00</span></h3>
                            </div>
                            <hr>
                            <div>
                                <span id="label-troco" class="text-muted d-block small">RESTANTE</span>
                                <h2 id="valor-troco" class="display-6 fw-bold text-danger">R$ 0.00</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-white">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Voltar</button>
                <button type="button" id="btn-confirmar-final" class="btn btn-success btn-lg px-5 fw-bold" onclick="enviarVenda()" disabled>FINALIZAR</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalSucesso" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg text-center p-5">
            <i class="bi bi-check-circle-fill text-success" style="font-size: 5rem;"></i>
            <h2 class="fw-bold">Venda Finalizada!</h2>
            <div class="d-grid gap-2 mt-4">
                <button class="btn btn-primary py-3 fw-bold" onclick="window.location.reload()">NOVA VENDA</button>
                <a href="{{ url_for('vendas.relatorio') }}" class="btn btn-outline-dark">VER RELATÓRIO</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let totalVenda = 0;
    let pagamentos = [];

    // 1. Busca AJAX
    const campoBusca = document.getElementById('campo-busca');
    const listaBusca = document.getElementById('lista-busca');

    campoBusca.addEventListener('input', async function(e) {
        const query = e.target.value;
        if (query.length < 2) return;
        const response = await fetch(`/vendas/buscar_itens?q=${query}`);
        const itens = await response.json();
        listaBusca.innerHTML = itens.map(item => `
            <div class="list-group-item d-flex justify-content-between align-items-center py-3">
                <div>
                    <span class="badge ${item.tipo === 'produto' ? 'bg-primary' : 'bg-info'}">${item.tipo.toUpperCase()}</span>
                    <h6 class="mb-0 fw-bold">${item.nome}</h6>
                    <small>Estoque: ${item.estoque} | R$ ${item.preco.toFixed(2)}</small>
                </div>
                <button class="btn btn-outline-primary rounded-pill px-3" onclick="abrirAjuste('${item.id}', '${item.nome}', ${item.preco}, '${item.tipo}')">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </div>`).join('');
    });

    // 2. Lógica do Cupom
    function abrirAjuste(id, nome, preco, tipo) {
        document.getElementById('idItemModal').value = id;
        document.getElementById('tipoItemModal').value = tipo;
        document.getElementById('nomeItemModal').innerText = nome;
        document.getElementById('precoModal').value = preco;
        new bootstrap.Modal(document.getElementById('modalAjusteItem')).show();
    }

    function confirmarInclusao() {
        const id = document.getElementById('idItemModal').value;
        const tipo = document.getElementById('tipoItemModal').value;
        const nome = document.getElementById('nomeItemModal').innerText;
        const qtd = parseInt(document.getElementById('qtdModal').value);
        const preco = parseFloat(document.getElementById('precoModal').value);
        const subtotal = qtd * preco;

        if (document.getElementById('aviso-vazio')) document.getElementById('aviso-vazio').remove();

        const itemHtml = `
            <div class="item-cupom border-bottom mb-2 pb-2" data-id="${id}" data-tipo="${tipo}" data-qtd="${qtd}" data-preco="${preco}">
                <div class="d-flex justify-content-between">
                    <div><b>${nome}</b><br><small>${qtd}x R$ ${preco.toFixed(2)}</small></div>
                    <div class="text-end"><b>R$ ${subtotal.toFixed(2)}</b><br>
                    <button class="btn btn-sm text-danger p-0" onclick="removerItem(this, ${subtotal})"><i class="bi bi-x-circle"></i></button></div>
                </div>
            </div>`;
        
        document.getElementById('lista-itens-cupom').insertAdjacentHTML('beforeend', itemHtml);
        atualizarTotal(subtotal);
        bootstrap.Modal.getInstance(document.getElementById('modalAjusteItem')).hide();
        campoBusca.value = ""; campoBusca.focus();
    }

    function atualizarTotal(valor) {
        totalVenda += valor;
        document.getElementById('valor-total-cupom').innerText = totalVenda.toFixed(2);
        document.getElementById('btn-finalizar').disabled = totalVenda <= 0;
    }

    function removerItem(botao, valorItem) {
        botao.closest('.item-cupom').remove();
        atualizarTotal(-valorItem);
    }

    // 3. Lógica de Pagamento
    function adicionarPagamento() {
        const forma = document.getElementById('select_forma').value;
        const valor = parseFloat(document.getElementById('valor_parcial').value);
        if (isNaN(valor) || valor <= 0) return;
        pagamentos.push({ forma, valor });
        renderizarPagamentos();
        atualizarDashboard();
    }

    function renderizarPagamentos() {
        document.getElementById('lista-pagamentos').innerHTML = pagamentos.map((p, i) => `
            <div class="list-group-item d-flex justify-content-between py-2">
                <span>${p.forma}</span><b>R$ ${p.valor.toFixed(2)}</b>
                <button class="btn btn-sm text-danger" onclick="removerPagamento(${i})"><i class="bi bi-trash"></i></button>
            </div>`).join('');
    }

    function removerPagamento(i) {
        pagamentos.splice(i, 1);
        renderizarPagamentos();
        atualizarDashboard();
    }

    function atualizarDashboard() {
        const pago = pagamentos.reduce((acc, p) => acc + p.valor, 0);
        const restante = totalVenda - pago;
        document.getElementById('dash-total').innerText = totalVenda.toFixed(2);
        document.getElementById('dash-pago').innerText = pago.toFixed(2);
        const dashTroco = document.getElementById('valor-troco');
        if (restante > 0) {
            dashTroco.innerText = `R$ ${restante.toFixed(2)}`;
            dashTroco.className = "display-6 fw-bold text-danger";
            document.getElementById('btn-confirmar-final').disabled = true;
        } else {
            dashTroco.innerText = `R$ ${Math.abs(restante).toFixed(2)}`;
            dashTroco.className = "display-6 fw-bold text-success";
            document.getElementById('btn-confirmar-final').disabled = false;
        }
    }

    async function enviarVenda() {
        const itens = [];
        document.querySelectorAll('.item-cupom').forEach(el => {
            itens.push({ id: el.dataset.id, tipo: el.dataset.tipo, quantidade: el.dataset.qtd, preco: el.dataset.preco });
        });
        const dados = {
            itens: itens, pagamentos: pagamentos,
            cliente_id: document.getElementById('cliente_id').value,
            data_venda: document.getElementById('data_venda').value
        };
        const resp = await fetch('/vendas/finalizar', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dados)
        });
        if (resp.ok) {
            bootstrap.Modal.getInstance(document.getElementById('modalPagamento')).hide();
            new bootstrap.Modal(document.getElementById('modalSucesso')).show();
        }
    }

    // Atualiza dashboard ao abrir modal
    document.getElementById('modalPagamento').addEventListener('show.bs.modal', atualizarDashboard);
</script>
{% endblock %}