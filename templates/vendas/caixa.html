{% extends "base.html" %}

{% block content %}
<div class="row g-3" style="height: 85vh;">
    <div class="col-md-8">
        <div class="card h-100 shadow-sm border-0">
            <div class="card-header bg-white py-3 border-0">
                <div class="input-group input-group-lg shadow-sm">
                    <span class="input-group-text bg-light border-end-0"><i class="bi bi-search text-primary"></i></span>
                    <input type="text" id="campo-busca" class="form-control bg-light border-start-0" 
                           placeholder="Digite o nome do produto ou serviço..." autocomplete="off" autofocus>
                </div>
            </div>
            <div class="card-body overflow-auto p-0" id="container-resultados">
                <div id="lista-busca" class="list-group list-group-flush">
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-arrow-up-circle fs-1 d-block mb-2"></i>
                        Comece a digitar para buscar itens...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card h-100 shadow-sm border-primary border-2">
            <div class="card-header bg-primary text-white text-center py-3">
                <h5 class="mb-0 fw-bold"><i class="bi bi-receipt me-2"></i>CUPOM DE VENDA</h5>
            </div>
            <div class="card-body d-flex flex-column p-0">
                <div class="flex-grow-1 p-3 overflow-auto" id="lista-itens-cupom">
                    <div id="aviso-vazio" class="text-center py-5 text-muted">
                        <i class="bi bi-cart3 fs-1 d-block"></i>
                        Aguardando itens...
                    </div>
                </div>

                <div class="bg-dark p-3 text-white">
                    <div class="d-flex justify-content-between h4 mb-3">
                        <span class="opacity-75">TOTAL:</span>
                        <span class="fw-bold text-warning">R$ <span id="valor-total-cupom">0.00</span></span>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-light w-50" onclick="limparCupom()">
                            <i class="bi bi-trash"></i> Limpar
                        </button>
                        <button class="btn btn-warning w-50 fw-bold shadow-sm" id="btn-finalizar" 
                                data-bs-toggle="modal" data-bs-target="#modalPagamento" disabled>
                            PAGAMENTO
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAjusteItem" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-dark text-white">
                <h6 class="modal-title" id="nomeItemModal">Ajustar Item</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="idItemModal">
                <input type="hidden" id="tipoItemModal">
                
                <div class="mb-3">
                    <label class="form-label small fw-bold">Quantidade</label>
                    <input type="number" id="qtdModal" class="form-control form-control-lg text-center fw-bold" value="1" min="1">
                </div>
                
                <div class="mb-3">
                    <label class="form-label small fw-bold">Preço Unitário (R$)</label>
                    <input type="number" step="0.01" id="precoModal" class="form-control form-control-lg text-center text-success fw-bold">
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-primary w-100 py-2 fw-bold" onclick="confirmarInclusao()">
                    CONFIRMAR NO CUPOM
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalPagamento" tabindex="-1">
    </div>

<div class="modal fade" id="modalSucesso" data-bs-backdrop="static" tabindex="-1">
    </div>

{% endblock %}

{% block scripts %}
<script>
    let totalVenda = 0;
    let pagamentos = [];

    // 1. BUSCA DINÂMICA (AJAX) - Une Produtos e Serviços
    const campoBusca = document.getElementById('campo-busca');
    const listaBusca = document.getElementById('lista-busca');

    campoBusca.addEventListener('input', async function(e) {
        const query = e.target.value;
        if (query.length < 2) return;

        try {
            const response = await fetch(`/vendas/buscar_itens?q=${query}`);
            const itens = await response.json();
            
            listaBusca.innerHTML = itens.map(item => `
                <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3">
                    <div>
                        <span class="badge ${item.tipo === 'produto' ? 'bg-primary' : 'bg-info text-dark'} mb-1">
                            ${item.tipo.toUpperCase()}
                        </span>
                        <h6 class="mb-0 fw-bold">${item.nome}</h6>
                        <small class="text-muted">
                            Estoque: ${item.estoque} | Preço: R$ ${item.preco.toFixed(2)}
                        </small>
                    </div>
                    <button class="btn btn-outline-primary rounded-pill px-3 shadow-sm" 
                            onclick="abrirAjuste('${item.id}', '${item.nome}', ${item.preco}, '${item.tipo}')">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                </div>
            `).join('');
            
            if (itens.length === 0) {
                listaBusca.innerHTML = '<div class="p-4 text-center text-muted">Nenhum item encontrado.</div>';
            }
        } catch (err) {
            console.error("Erro na busca:", err);
        }
    });

    // 2. ABRE O MODAL DE AJUSTE
    function abrirAjuste(id, nome, preco, tipo) {
        document.getElementById('idItemModal').value = id;
        document.getElementById('tipoItemModal').value = tipo;
        document.getElementById('nomeItemModal').innerText = nome;
        document.getElementById('precoModal').value = preco;
        document.getElementById('qtdModal').value = 1;
        
        const modal = new bootstrap.Modal(document.getElementById('modalAjusteItem'));
        modal.show();
    }

    // 3. CONFIRMA NO CUPOM
    function confirmarInclusao() {
        const id = document.getElementById('idItemModal').value;
        const tipo = document.getElementById('tipoItemModal').value;
        const nome = document.getElementById('nomeItemModal').innerText;
        const qtd = parseInt(document.getElementById('qtdModal').value);
        const preco = parseFloat(document.getElementById('precoModal').value);
        const subtotal = qtd * preco;

        if (document.getElementById('aviso-vazio')) document.getElementById('aviso-vazio').remove();

        const itemHtml = `
            <div class="item-cupom border-bottom mb-2 pb-2" 
                 data-id="${id}" data-tipo="${tipo}" data-qtd="${qtd}" data-preco="${preco}">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="fw-bold small">${nome}</div>
                        <small class="text-muted">${qtd}x R$ ${preco.toFixed(2)} [${tipo[0].toUpperCase()}]</small>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold small">R$ ${subtotal.toFixed(2)}</div>
                        <button class="btn btn-sm text-danger p-0" onclick="removerItem(this, ${subtotal})">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('lista-itens-cupom').insertAdjacentHTML('beforeend', itemHtml);
        atualizarTotal(subtotal);
        bootstrap.Modal.getInstance(document.getElementById('modalAjusteItem')).hide();
        campoBusca.value = "";
        campoBusca.focus();
    }

    function atualizarTotal(valor) {
        totalVenda += valor;
        document.getElementById('valor-total-cupom').innerText = totalVenda.toFixed(2);
        document.getElementById('btn-finalizar').disabled = totalVenda <= 0;
    }

    function removerItem(botao, valorItem) {
        botao.closest('.item-cupom').remove();
        atualizarTotal(-valorItem);
    }

    // 4. ENVIO FINAL (Tratando tipos)
    async function enviarVenda() {
        const itens = [];
        document.querySelectorAll('.item-cupom').forEach(el => {
            itens.push({
                id: el.dataset.id,
                tipo: el.dataset.tipo,
                quantidade: el.dataset.qtd,
                preco: el.dataset.preco
            });
        });

        const dados = {
            itens: itens,
            pagamentos: pagamentos,
            cliente_id: document.getElementById('cliente_id').value,
            data_venda: document.getElementById('data_venda').value
        };

        const resp = await fetch('/vendas/finalizar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dados)
        });

        if (resp.ok) {
            bootstrap.Modal.getInstance(document.getElementById('modalPagamento')).hide();
            new bootstrap.Modal(document.getElementById('modalSucesso')).show();
        }
    }

    // Funções de pagamento (adicionarPagamento, atualizarDashboard, etc) 
    // devem ser mantidas conforme o seu código original.
</script>
{% endblock %}