{% extends "base.html" %}

{% block content %}
<div class="row g-3" style="height: 80vh;">
    <div class="col-md-8">
        <div class="card h-100 shadow-sm">
            <div class="card-header bg-white py-3">
                <div class="input-group">
                    <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control bg-light border-start-0" placeholder="Pesquisar produto...">
                </div>
            </div>
            <div class="card-body overflow-auto p-0">
                <div class="list-group list-group-flush">
                    {% for produto in produtos %}
                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3">
                        <div>
                            <h6 class="mb-0 fw-bold">{{ produto.nome }}</h6>
                            <small class="text-muted">
                                Estoque: {{ produto.estoque_atual }} | 
                                Pre√ßo: R$ {{ "%.2f"|format(produto.preco_venda) }}
                            </small>
                        </div>
                        <button class="btn btn-outline-primary btn-sm rounded-pill px-3" 
                                data-bs-toggle="modal" 
                                data-bs-target="#modalAjusteItem"
                                data-id="{{ produto.id }}"
                                data-nome="{{ produto.nome }}"
                                data-preco="{{ produto.preco_venda }}">
                            <i class="bi bi-plus-lg me-1"></i>Adicionar
                        </button>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <p class="text-muted">Nenhum produto encontrado para esta papelaria.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card h-100 shadow-sm border-primary">
            <div class="card-header bg-primary text-white text-center py-3">
                <h5 class="mb-0"><i class="bi bi-receipt me-2"></i>Cupom de Venda</h5>
            </div>
            <div class="card-body d-flex flex-column p-0">
                <div class="flex-grow-1 p-3 overflow-auto" id="lista-itens-cupom">
                    <div id="aviso-vazio" class="text-center py-5 text-muted">
                        <i class="bi bi-cart3 fs-1 d-block"></i>
                        Aguardando produtos...
                    </div>
                </div>

                <div class="bg-light p-3 border-top">
                    <div class="d-flex justify-content-between h4 mb-3 text-primary">
                        <span>TOTAL:</span>
                        <span class="fw-bold">R$ <span id="valor-total-cupom">0.00</span></span>
                    </div>
                    <button class="btn btn-primary w-100 btn-lg shadow-sm" id="btn-finalizar" 
                            data-bs-toggle="modal" data-bs-target="#modalPagamento" disabled>
                        Finalizar Pagamento
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalAjusteItem" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-dark text-white">
                <h6 class="modal-title" id="nomeProdutoModal">Ajustar Item</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="idProdutoModal">
                
                <div class="mb-3">
                    <label class="form-label small fw-bold">Quantidade</label>
                    <input type="number" id="qtdModal" class="form-control form-control-lg text-center" value="1" min="1">
                </div>
                
                <div class="mb-3">
                    <label class="form-label small fw-bold">Pre√ßo Unit√°rio (R$)</label>
                    <input type="number" step="0.01" id="precoModal" class="form-control form-control-lg text-center text-success fw-bold">
                    <div class="form-text text-center">Voc√™ pode alterar para dar desconto.</div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-primary w-100 py-2" onclick="confirmarInclusao()">
                    Confirmar no Cupom
                </button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalPagamento" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Finalizar Venda</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <h2 class="display-4 fw-bold text-success mb-4">R$ <span id="total-final-modal">0,00</span></h2>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Forma de Pagamento</label>
                    <select id="forma_pagamento" class="form-select form-select-lg">
                        <option value="" selected disabled>Selecione...</option>
                        {% for forma in formas_pagamento %}
                            <option value="{{ forma.nome }}">{{ forma.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-success btn-lg w-100 py-3 fw-bold" onclick="enviarVenda()">
                    CONFIRMAR E FINALIZAR
                </button>
            </div>
        </div>
    </div>
</div>
<script>
    let totalVenda = 0;

    // 1. Preenche o Modal de Ajuste ao clicar em "Adicionar"
    var modalAjuste = document.getElementById('modalAjusteItem');
    modalAjuste.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        document.getElementById('idProdutoModal').value = button.getAttribute('data-id');
        document.getElementById('nomeProdutoModal').innerText = button.getAttribute('data-nome');
        document.getElementById('precoModal').value = button.getAttribute('data-preco');
        document.getElementById('qtdModal').value = 1;
    });

    // 2. Adiciona o item ajustado ao Cupom
    function confirmarInclusao() {
        const id = document.getElementById('idProdutoModal').value;
        const nome = document.getElementById('nomeProdutoModal').innerText;
        const qtd = parseInt(document.getElementById('qtdModal').value);
        const preco = parseFloat(document.getElementById('precoModal').value);
        const subtotal = qtd * preco;

        const avisoVazio = document.getElementById('aviso-vazio');
        if (avisoVazio) avisoVazio.remove();

        const lista = document.getElementById('lista-itens-cupom');
        // AJUSTE: Adicionamos data-id, data-qtd e data-preco na div para facilitar a leitura depois
        const itemHtml = `
            <div class="d-flex justify-content-between align-items-start border-bottom mb-2 pb-2 item-cupom" 
                data-id="${id}" data-qtd="${qtd}" data-preco="${preco.toFixed(2)}" data-subtotal="${subtotal}">
                <div class="me-auto">
                    <div class="fw-bold">${nome}</div>
                    <small class="text-muted">${qtd} un x R$ ${preco.toFixed(2)}</small>
                </div>
                <div class="text-end">
                    <div class="fw-bold">R$ ${subtotal.toFixed(2)}</div>
                    <button class="btn btn-link btn-sm text-danger p-0" 
                            onclick="removerItem(this, ${subtotal})">
                        Remover
                    </button>
                </div>
            </div>
        `;
        lista.insertAdjacentHTML('beforeend', itemHtml);

        totalVenda += subtotal;
        document.getElementById('valor-total-cupom').innerText = totalVenda.toFixed(2);
        document.getElementById('btn-finalizar').disabled = false;

        bootstrap.Modal.getInstance(modalAjuste).hide();
    }

    // 3. Remove item e atualiza total
    function removerItem(botao, valorItem) {
        const linha = botao.closest('.item-cupom');
        linha.remove();
        totalVenda -= valorItem;
        if (totalVenda < 0) totalVenda = 0;
        document.getElementById('valor-total-cupom').innerText = totalVenda.toFixed(2);

        const lista = document.getElementById('lista-itens-cupom');
        if (lista.querySelectorAll('.item-cupom').length === 0) {
            lista.innerHTML = `<div id="aviso-vazio" class="text-center py-5 text-muted"><i class="bi bi-cart3 fs-1 d-block"></i>Aguardando produtos...</div>`;
            document.getElementById('btn-finalizar').disabled = true;
        }
    }

    // 4. Prepara o Modal de Pagamento com o Total
document.getElementById('modalPagamento').addEventListener('show.bs.modal', function () {
    document.getElementById('total-final-modal').innerText = totalVenda.toFixed(2);
});

// 5. NOVA L√ìGICA DE BUSCA EM TEMPO REAL
document.querySelector('input[placeholder="Pesquisar produto..."]').addEventListener('input', function(e) {
    const termo = e.target.value.toLowerCase();
    const itens = document.querySelectorAll('.list-group-item');
    
    itens.forEach(item => {
        const nome = item.querySelector('h6').innerText.toLowerCase();
        if (nome.includes(termo)) {
            item.classList.remove('d-none');
            item.classList.add('d-flex');
        } else {
            item.classList.remove('d-flex');
            item.classList.add('d-none');
        }
    });
});

// 6. ENVIO FINAL PARA O PYTHON (CORRIGIDO)
    async function enviarVenda() {
        const itens = [];
        const linhas = document.querySelectorAll('.item-cupom');
        
        // CORRE√á√ÉO: Captura o valor do SELECT, n√£o de um radio button
        const selectPagamento = document.getElementById('forma_pagamento');
        const formaPagamento = selectPagamento.value;

        if (!formaPagamento) {
            alert("‚ö†Ô∏è Por favor, selecione uma forma de pagamento!");
            return;
        }

        if (linhas.length === 0) {
            alert("üõí O cupom est√° vazio!");
            return;
        }

        linhas.forEach(linha => {
            itens.push({
                produto_id: linha.getAttribute('data-id'), 
                quantidade: parseInt(linha.getAttribute('data-qtd')),
                preco_venda: parseFloat(linha.getAttribute('data-preco'))
            });
        });

        try {
            const response = await fetch('/vendas/finalizar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    itens: itens,
                    forma_pagamento: formaPagamento 
                })
            });

            const result = await response.json();

            if (response.ok && result.status === 'success') {
                alert("‚úÖ Venda registrada com sucesso!");
                window.location.reload(); 
            } else {
                alert("‚ùå Erro: " + (result.message || "Erro desconhecido"));
            }
        } catch (error) {
            console.error("Erro na requisi√ß√£o:", error);
            alert("üöÄ Erro de conex√£o. O servidor est√° rodando?");
        }
    }
</script>
{% endblock %}