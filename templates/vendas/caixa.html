{% extends "base.html" %}

{% block content %}
<div class="row g-3" style="height: 85vh;">
    <div class="col-md-8">
        <div class="card h-100 shadow-sm border-0">
            <div class="card-header bg-white py-3 border-0">
                <div class="input-group input-group-lg shadow-sm">
                    <span class="input-group-text bg-light border-end-0"><i class="bi bi-search text-primary"></i></span>
                    <input type="text" id="campo-busca" class="form-control bg-light border-start-0" 
                           placeholder="Digite o nome do produto ou serviço..." autocomplete="off" autofocus>
                </div>
            </div>
            <div class="card-body overflow-auto p-0">
                <div id="lista-busca" class="list-group list-group-flush">
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-arrow-up-circle fs-1 d-block mb-2"></i>
                        Comece a digitar para buscar itens...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card h-100 shadow-sm border-primary border-2">
            <div class="card-header bg-primary text-white text-center py-3">
                <h5 class="mb-0 fw-bold"><i class="bi bi-receipt me-2"></i>CUPOM DE VENDA</h5>
            </div>
            <div class="card-body d-flex flex-column p-0">
                <div class="flex-grow-1 p-3 overflow-auto" id="lista-itens-cupom">
                    <div id="aviso-vazio" class="text-center py-5 text-muted">
                        <i class="bi bi-cart3 fs-1 d-block"></i> Aguardando itens...
                    </div>
                </div>

                <div class="bg-dark p-3 text-white">
                    <div class="d-flex justify-content-between h4 mb-3">
                        <span class="opacity-75">TOTAL:</span>
                        <span class="fw-bold text-warning">R$ <span id="valor-total-cupom">0.00</span></span>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-light w-50" onclick="limparCupom()">
                            <i class="bi bi-trash"></i> Limpar
                        </button>
                        <button class="btn btn-warning w-50 fw-bold shadow-sm" id="btn-finalizar" 
                                data-bs-toggle="modal" data-bs-target="#modalPagamento" disabled>
                            PAGAMENTO
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAjusteItem" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-dark text-white">
                <h6 class="modal-title" id="nomeItemModal">Ajustar Item</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="idItemModal">
                <input type="hidden" id="tipoItemModal">
                <div class="mb-3">
                    <label class="form-label small fw-bold">Quantidade</label>
                    <input type="number" id="qtdModal" class="form-control form-control-lg text-center" value="1" min="1">
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold">Preço Unitário (R$)</label>
                    <input type="number" step="0.01" id="precoModal" class="form-control form-control-lg text-center text-success fw-bold">
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-primary w-100 py-2 fw-bold" onclick="confirmarInclusao()">CONFIRMAR</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalPagamento" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold"><i class="bi bi-cash-stack me-2"></i>Finalizar Checkout</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
                <div class="row">
                    <div class="col-md-7 border-end">
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted">CLIENTE</label>
                            <select id="cliente_id" class="form-select shadow-sm">
                                <option value=""></option>
                                {% for cliente in clientes %}
                                    <option value="{{ cliente.id }}">{{ cliente.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="card shadow-sm mb-3">
                            <div class="card-body">
                                <label class="form-label fw-bold small text-muted">FORMA DE PAGAMENTO</label>
                                <div class="input-group">
                                    <select id="select_forma" class="form-select">
                                        {% for forma in formas_pagamento %}
                                            <option value="{{ forma.nome }}">{{ forma.nome }}</option>
                                        {% endfor %}
                                    </select>
                                    <input type="number" id="valor_parcial" class="form-control" placeholder="R$ 0,00" step="0.01">
                                    <button class="btn btn-success" onclick="adicionarPagamento()">
                                        <i class="bi bi-plus-lg"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="lista-pagamentos" class="list-group shadow-sm mb-3"></div>
                        <input type="date" id="data_venda" class="form-control shadow-sm" value="{{ now.strftime('%Y-%m-%d') }}">
                    </div>
                    <div class="col-md-5">
                        <div class="card bg-white h-100 border-0 shadow-sm text-center p-3">
                            <div class="mb-3">
                                <span class="text-muted d-block small">VALOR A PAGAR</span>
                                <h3 class="text-dark fw-bold">R$ <span id="dash-total">0.00</span></h3>
                            </div>
                            <div class="mb-3">
                                <span class="text-muted d-block small">VALOR PAGO</span>
                                <h3 class="text-primary fw-bold">R$ <span id="dash-pago">0.00</span></h3>
                            </div>
                            <hr>
                            <div>
                                <span id="label-troco" class="text-muted d-block small">RESTANTE</span>
                                <h2 id="valor-troco" class="display-6 fw-bold text-danger">R$ 0.00</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-white">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Voltar</button>
                <button type="button" id="btn-confirmar-final" class="btn btn-success btn-lg px-5 fw-bold" onclick="enviarVenda()" disabled>FINALIZAR</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalSucesso" data-bs-backdrop="static" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"> <div class="modal-content border-0 shadow-lg text-center p-5">
            <div class="modal-body"> <i class="bi bi-check-circle-fill text-success" style="font-size: 5rem;"></i>
                <h2 class="fw-bold mt-3">Venda Finalizada!</h2>
                <div class="d-grid gap-2 mt-4">
                    <button class="btn btn-success py-3 fw-bold" onclick="imprimirCupom()">
                        <i class="bi bi-printer me-2"></i> IMPRIMIR CUPOM
                    </button>
                    <button class="btn btn-primary py-3 fw-bold" onclick="window.location.reload()">NOVA VENDA</button>
                    <a href="{{ url_for('vendas.relatorio') }}" class="btn btn-link text-muted text-decoration-none">Ver Relatório</a>
                </div>
            </div>
        </div>
    </div> 
</div>
{% endblock %}

{% block scripts %}
<script>
    let totalVenda = 0;
    let pagamentos = [];
    let itensAtuais = []; // <--- ADICIONADO: Variável global essencial para o Enter

    const campoBusca = document.getElementById('campo-busca');
    const listaBusca = document.getElementById('lista-busca');

    // 1. FUNÇÃO PARA BUSCAR E RENDERIZAR
    async function carregarItens(query = "") {
        const response = await fetch(`/vendas/buscar_itens?q=${query}`);
        const itens = await response.json();
        
        // --- ADICIONADO: Salva os itens na variável global para o Enter funcionar ---
        itensAtuais = itens; 

        if (itens.length === 0) {
            listaBusca.innerHTML = '<div class="text-center py-5 text-muted">Nenhum item encontrado.</div>';
            return;
        }

        listaBusca.innerHTML = itens.map(item => `
            <div class="list-group-item d-flex justify-content-between align-items-center py-3">
                <div>
                    <span class="badge ${item.tipo === 'produto' ? 'bg-primary' : 'bg-info'}">${item.tipo.toUpperCase()}</span>
                    <h6 class="mb-0 fw-bold">${item.nome}</h6>
                    <small>Estoque: ${item.estoque} | R$ ${item.preco.toFixed(2)}</small>
                </div>
                <button class="btn btn-outline-primary rounded-pill px-3" onclick="abrirAjuste('${item.id}', '${item.nome}', ${item.preco}, '${item.tipo}')">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </div>`).join('');
    }

    // --- TURBO DO ENTER (CORRIGIDO) ---
    campoBusca.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault(); 

            // Verifica se a lista global de itens tem exatamente um item
            if (itensAtuais && itensAtuais.length === 1) {
                const item = itensAtuais[0];
                abrirAjuste(item.id, item.nome, item.preco, item.tipo);
            } 
            else if (itensAtuais && itensAtuais.length > 1) {
                // Opcional: Você pode emitir um som ou aviso visual aqui
                console.log("Muitos itens na lista, seja mais específico.");
            }
        }
    });

    // 2. EXECUTAR AO CARREGAR A PÁGINA
    window.addEventListener('DOMContentLoaded', (event) => {
        campoBusca.focus();
        carregarItens(); // Carrega todos os itens em ordem alfabética
    });

    // 3. EVENTO DE DIGITAÇÃO
    campoBusca.addEventListener('input', function(e) {
        carregarItens(e.target.value);
    });

    // 4. Lógica do Cupom
    function abrirAjuste(id, nome, preco, tipo) {
        document.getElementById('idItemModal').value = id;
        document.getElementById('tipoItemModal').value = tipo;
        document.getElementById('nomeItemModal').innerText = nome;
        document.getElementById('precoModal').value = preco;
        
        const meuModal = new bootstrap.Modal(document.getElementById('modalAjusteItem'));
        meuModal.show();
    }

    function confirmarInclusao() {
        const id = document.getElementById('idItemModal').value;
        const tipo = document.getElementById('tipoItemModal').value;
        const nome = document.getElementById('nomeItemModal').innerText;
        const qtd = parseInt(document.getElementById('qtdModal').value);
        const preco = parseFloat(document.getElementById('precoModal').value);
        const subtotal = qtd * preco;

        if (document.getElementById('aviso-vazio')) document.getElementById('aviso-vazio').remove();

        const itemHtml = `
            <div class="item-cupom border-bottom mb-2 pb-2" data-id="${id}" data-tipo="${tipo}" data-qtd="${qtd}" data-preco="${preco}">
                <div class="d-flex justify-content-between">
                    <div><b>${nome}</b><br><small>${qtd}x R$ ${preco.toFixed(2)}</small></div>
                    <div class="text-end"><b>R$ ${subtotal.toFixed(2)}</b><br>
                    <button class="btn btn-sm text-danger p-0" onclick="removerItem(this, ${subtotal})"><i class="bi bi-x-circle"></i></button></div>
                </div>
            </div>`;
        
        document.getElementById('lista-itens-cupom').insertAdjacentHTML('beforeend', itemHtml);
        atualizarTotal(subtotal);
        
        // Fecha o modal e limpa busca
        const modalEl = document.getElementById('modalAjusteItem');
        const modalInstance = bootstrap.Modal.getInstance(modalEl);
        if (modalInstance) modalInstance.hide();

        campoBusca.value = "";
        carregarItens(); // Volta para a lista completa alfabética
        campoBusca.focus();
    }

    // --- (As demais funções: atualizarTotal, removerItem, adicionarPagamento, etc. permanecem as mesmas) ---

    function atualizarTotal(valor) {
        totalVenda += valor;
        document.getElementById('valor-total-cupom').innerText = totalVenda.toFixed(2);
        document.getElementById('btn-finalizar').disabled = totalVenda <= 0;
    }

    function removerItem(botao, valorItem) {
        botao.closest('.item-cupom').remove();
        atualizarTotal(-valorItem);
    }

    function adicionarPagamento() {
        const forma = document.getElementById('select_forma').value;
        const valor = parseFloat(document.getElementById('valor_parcial').value);
        if (isNaN(valor) || valor <= 0) return;
        pagamentos.push({ forma, valor });
        renderizarPagamentos();
        atualizarDashboard();
        document.getElementById('valor_parcial').value = ""; // Limpa o campo após adicionar
    }

    function renderizarPagamentos() {
        document.getElementById('lista-pagamentos').innerHTML = pagamentos.map((p, i) => `
            <div class="list-group-item d-flex justify-content-between py-2">
                <span>${p.forma}</span><b>R$ ${p.valor.toFixed(2)}</b>
                <button class="btn btn-sm text-danger" onclick="removerPagamento(${i})"><i class="bi bi-trash"></i></button>
            </div>`).join('');
    }

    function removerPagamento(i) {
        pagamentos.splice(i, 1);
        renderizarPagamentos();
        atualizarDashboard();
    }

    function atualizarDashboard() {
        const pago = pagamentos.reduce((acc, p) => acc + p.valor, 0);
        const restante = totalVenda - pago;
        document.getElementById('dash-total').innerText = totalVenda.toFixed(2);
        document.getElementById('dash-pago').innerText = pago.toFixed(2);
        const dashTroco = document.getElementById('valor-troco');
        if (restante > 0) {
            dashTroco.innerText = `R$ ${restante.toFixed(2)}`;
            dashTroco.className = "display-6 fw-bold text-danger";
            document.getElementById('btn-confirmar-final').disabled = true;
        } else {
            dashTroco.innerText = `R$ ${Math.abs(restante).toFixed(2)}`;
            dashTroco.className = "display-6 fw-bold text-success";
            document.getElementById('btn-confirmar-final').disabled = false;
        }
    }
    let ultimaVendaId = null;
    async function enviarVenda() {
        // 1. Captura o ID do cliente
        const clienteId = document.getElementById('cliente_id').value;

        // 2. Validação: Se o cliente estiver vazio (string vazia), exibe alerta e para a execução
        if (!clienteId) {
            alert("⚠️ Operação bloqueada: Por favor, selecione um cliente para finalizar a venda.");
            document.getElementById('cliente_id').focus(); // Dá foco no campo para facilitar
            return; // O 'return' impede que o código abaixo seja executado
        }

        const itens = [];
        document.querySelectorAll('.item-cupom').forEach(el => {
            itens.push({ 
                id: el.dataset.id, 
                tipo: el.dataset.tipo, 
                quantidade: el.dataset.qtd, 
                preco: el.dataset.preco 
            });
        });

        const dados = {
            itens: itens, 
            pagamentos: pagamentos,
            cliente_id: clienteId, // Usando a variável validada
            data_venda: document.getElementById('data_venda').value
        };

        const resp = await fetch('/vendas/finalizar', {
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dados)
        });

        if (resp.ok) {
            const resultado = await resp.json();
            ultimaVendaId = resultado.venda_id;

            // 1. Pega a instância do modal de pagamento e esconde
            const modalPagEl = document.getElementById('modalPagamento');
            const modalPag = bootstrap.Modal.getInstance(modalPagEl);
            if (modalPag) modalPag.hide();

            // 2. Pequeno atraso para evitar conflito de animação do Bootstrap
            setTimeout(() => {
                const mSucesso = new bootstrap.Modal(document.getElementById('modalSucesso'));
                mSucesso.show();
            }, 400); // 400ms é o tempo ideal para a animação de saída terminar
        } else {
            alert("Erro ao finalizar venda. Verifique os dados e tente novamente.");
        }
    }
    function imprimirCupom() {
        if (ultimaVendaId) {
            // Abre o cupom em uma nova aba/janela pequena
            window.open(`/vendas/cupom/${ultimaVendaId}`, '_blank', 'width=350,height=600');
        }
    }

    function limparCupom() {
        if (confirm("Deseja realmente cancelar esta venda?")) {
            totalVenda = 0;
            pagamentos = [];
            document.getElementById('lista-itens-cupom').innerHTML = '<div id="aviso-vazio" class="text-center py-5 text-muted"><i class="bi bi-cart3 fs-1 d-block"></i> Aguardando itens...</div>';
            document.getElementById('valor-total-cupom').innerText = "0.00";
            document.getElementById('btn-finalizar').disabled = true;
            campoBusca.value = "";
            carregarItens();
            campoBusca.focus();
        }
    }

    // Foca na quantidade ao abrir o modal
    document.getElementById('modalAjusteItem').addEventListener('shown.bs.modal', function () {
        const inputQtd = document.getElementById('qtdModal');
        inputQtd.focus();
        inputQtd.select();
    });

    // Atualiza os valores e preenche o campo automaticamente ao abrir o modal
    document.getElementById('modalPagamento').addEventListener('show.bs.modal', function () {
        // 1. Atualiza os textos de total, pago e restante
        atualizarDashboard();

        // 2. Calcula quanto ainda falta pagar
        const pago = pagamentos.reduce((acc, p) => acc + p.valor, 0);
        const restante = totalVenda - pago;

        // 3. Preenche o campo de valor com o que falta (se for maior que zero)
        const inputValorParcial = document.getElementById('valor_parcial');
        if (restante > 0) {
            inputValorParcial.value = restante.toFixed(2);
        } else {
            inputValorParcial.value = "";
        }

        // 4. Dá foco automático no campo de valor e seleciona o texto
        // O setTimeout de 500ms é necessário para o Bootstrap terminar a animação do modal
        setTimeout(() => {
            inputValorParcial.focus();
            inputValorParcial.select();
        }, 500);
    });
    document.getElementById('valor_parcial').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            adicionarPagamento();
        }
    });
    // Atualiza dashboard ao abrir modal de pagamento
    document.getElementById('modalPagamento').addEventListener('show.bs.modal', atualizarDashboard);
</script>
{% endblock %}